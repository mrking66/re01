# RK3566 ↔ STM32 通信协议文档

**版本：v1.0**
 **适用产品：AI 宠物陪伴/健康机器人 – 底盘控制系统**
 **通信方式：UART 全双工**
 **更新日期：2025-02**

------

# 1. 总体说明

本协议定义 **RK3566（上位机）** 与 **STM32（下位机）** 在机器人底盘控制中的通信格式、指令编号、Payload 结构、状态上报机制与故障处理机制。

两端职责：

| 模块   | 角色                  | 职责                                            |
| ------ | --------------------- | ----------------------------------------------- |
| RK3566 | 控制中心（AI + 决策） | 速度规划、跟随/巡航决策、云台控制、网络通信     |
| STM32  | 执行中心（Driver）    | 电机 PID 控制、编码器读取、安全保护、传感器管理 |

------

# 2. 通信规格

- **通信接口**：UART
- **波特率**：921600（推荐）
- **帧格式**：无校验，8N1
- **CRC 校验**：CRC8/MAXIM
- **通信模式**：主从模式（RK 主控，STM 执行）

------

# 3. 数据帧结构

所有数据帧格式如下：

```
[HEADER 2B] [CMD 1B] [LEN 1B] [PAYLOAD N] [CRC 1B]
```

| 字段    | 长度    | 说明                                 |
| ------- | ------- | ------------------------------------ |
| HEADER  | 2 bytes | 固定为 `0x55 0xAA`                   |
| CMD     | 1 byte  | 指令类型                             |
| LEN     | 1 byte  | PAYLOAD 长度                         |
| PAYLOAD | N bytes | 指令参数                             |
| CRC     | 1 byte  | 对 CMD + LEN + PAYLOAD 做 CRC8/MAXIM |

------

# 4. CMD 列表（总表）

| CMD 值   | 方向     | 意义                           |
| -------- | -------- | ------------------------------ |
| **0x01** | RK → STM | 底盘运动控制（线速度/角速度）  |
| **0x02** | RK → STM | 停止运动                       |
| **0x03** | RK → STM | 云台角度控制                   |
| **0x04** | RK → STM | 控制模式切换（避障/增稳/跟随） |
| **0x10** | RK → STM | 请求状态                       |
| **0x11** | RK → STM | 电机/编码器校准指令            |
| **0x12** | RK → STM | 重启 STM32                     |
| **0x13** | RK → STM | 急停（电机关闭）               |
| **0x81** | STM → RK | 状态上报                       |
| **0x82** | STM → RK | 安全事件（撞击/欠压/过流等）   |
| **0x83** | STM → RK | 传感器扩展数据（ToF/IMU）      |

------

# 5. RK3566 → STM32 指令格式

------

## 5.1 CMD = 0x01 —— 底盘速度控制（核心）

**用途**：机器人差速驱动控制（每 10–50ms 发送）

### Payload 格式

| 字段          | 类型  | 单位        | 说明             |
| ------------- | ----- | ----------- | ---------------- |
| linear_speed  | int16 | mm/s        | -800 ~ +800      |
| angular_speed | int16 | 0.001 rad/s | -1500 ~ +1500    |
| control_mode  | uint8 | 枚举        | 控制模式（见下） |
| reserved      | uint8 | -           | 保留字段         |

### control_mode 枚举

| 值   | 模式         | 作用                         |
| ---- | ------------ | ---------------------------- |
| 0x00 | 标准模式     | 普通底盘控制                 |
| 0x01 | 避障模式     | ToF 输入触发自动减速/刹车    |
| 0x02 | 增稳模式     | 回充/狭窄场景，低速平稳      |
| 0x03 | 跟随模式     | 跟随 AI 策略的平滑加速度曲线 |
| 0x04 | 手动调试模式 | 工厂/调试用，无限制          |

### 示例

```
55 AA 01 06 01 F4 00 C8 01 00 CRC
```

含义：

- linear = +500mm/s
- angular = +0.2 rad/s
- 控制模式 = 避障模式

------

## 5.2 CMD = 0x02 —— 停止运动

无 Payload。

### 示例

```
55 AA 02 00 CRC
```

STM32 应立即将电机 PWM 设置为零并进入 SAFE_IDLE 状态。

------

## 5.3 CMD = 0x03 —— 云台角度控制

### Payload

| 字段      | 类型  | 说明                        |
| --------- | ----- | --------------------------- |
| pitch_deg | int16 | 云台俯仰角度（-20° ~ +40°） |

### 示例

```
55 AA 03 02 00 14 CRC
```

------

## 5.4 CMD = 0x04 —— 控制模式切换（新增）

用于切换底盘执行逻辑，而不依赖速度指令中的控制模式。

### Payload

| 字段  | 类型  | 描述                      |
| ----- | ----- | ------------------------- |
| mode  | uint8 | 控制模式（参考表）        |
| param | uint8 | 系数/灵敏度（如限速等级） |

------

## 5.5 CMD = 0x10 —— 请求状态

STM 必须立即回复一帧 CMD=0x81 状态包。

```
55 AA 10 00 CRC
```

------

## 5.6 CMD = 0x11 —— 编码器与电机校准

### Payload

| 字段   | 类型  | 意义                     |
| ------ | ----- | ------------------------ |
| action | uint8 | 0=读取 1=校准 2=恢复默认 |
| param  | uint8 | 保留                     |

------

## 5.7 CMD = 0x12 —— 重启 STM32

```
55 AA 12 00 CRC
```

------

## 5.8 CMD = 0x13 —— 急停（电机关闭）

STM32 必须立即关闭 PWM，不允许执行任何移动指令。

```
55 AA 13 00 CRC
```

------

# 6. STM32 → RK3566 上报格式

------

## 6.1 CMD = 0x81 —— 状态上报（周期 20–100ms）

### Payload 结构（标准版）

| 字段          | 类型   | 说明             |
| ------------- | ------ | ---------------- |
| battery_mv    | uint16 | 电池电压         |
| current_ma    | uint16 | 系统电流         |
| left_encoder  | int32  | 左轮编码器累计值 |
| right_encoder | int32  | 右轮编码器累计值 |
| mcu_temp      | int8   | MCU 温度（℃）    |
| motor_temp    | int8   | 电机温度（℃）    |
| run_mode      | uint8  | 当前底盘模式     |
| error_code    | uint8  | 错误码（见下）   |

### error_code 表

| code | 意义         |
| ---- | ------------ |
| 0x00 | 正常         |
| 0x01 | 电机过流     |
| 0x02 | 电池欠压     |
| 0x03 | 撞击检测     |
| 0x04 | 急停开关触发 |
| 0x05 | 电机堵转     |
| 0x06 | 过温         |

------

## 6.2 CMD = 0x82 —— 安全事件（紧急）

STM32 检测到危险时立即发送（无需等待周期）

### Payload

| 字段       | 类型  | 意义                   |
| ---------- | ----- | ---------------------- |
| event_type | uint8 | 事件类型               |
| detail     | uint8 | 附加数据，例如过流等级 |

### 事件类型表

| 值   | 事件          |
| ---- | ------------- |
| 0x01 | 撞击检测      |
| 0x02 | 电机过流      |
| 0x03 | 电池过压/欠压 |
| 0x04 | 急停触发      |
| 0x05 | 电机堵转      |
| 0x06 | 过温保护      |

------

## 6.3 CMD = 0x83 —— 传感器扩展数据

适用于 ToF、IMU 等传感器连接在 STM32 的场景。

### Payload 示例

| 字段   | 类型   | 描述             |
| ------ | ------ | ---------------- |
| tof_mm | uint16 | ToF 距离（mm）   |
| acc_x  | int16  | 加速度 X（mg）   |
| acc_y  | int16  | 加速度 Y（mg）   |
| acc_z  | int16  | 加速度 Z（mg）   |
| gyro_x | int16  | 陀螺仪 X（mdps） |
| gyro_y | int16  | 陀螺仪 Y（mdps） |
| gyro_z | int16  | 陀螺仪 Z（mdps） |

------

# 7. 安全控制逻辑（强制要求）

------

## 7.1 STM32 必须实现的安全机制

### ① 指令超时保护

若 **300ms 内未收到 CMD=0x01（速度指令）**
 → 立即停止电机 → 进入 SAFE_STOP 状态

### ② 过流保护

- 立即关闭 PWM
- 上报事件 0x82（event_type=0x02）

### ③ 电池欠压保护

- 限速 → 自动停机 → 上报 0x82（0x03）

### ④ 撞击检测

- 马上急停 → 上报 0x82（0x01）

### ⑤ 急停物理开关

- 无条件强制停机

------

## 7.2 RK3566 必须遵守的逻辑

- 每 20–50ms 必须发送速度指令（心跳）
- 接收到 0x82 必须立即停止控制并进入 paused 状态
- 速度输出必须经过滤波（避免突然加速）

------

# 8. 状态机（标准版）

------

## 8.1 STM32 状态机

```
[IDLE]
   ↓ 接收到速度指令
[RUNNING]
   ↓ 安全事件（撞击/过流）
[SAFE_STOP]
   ↓ 清除错误命令
[IDLE]
```

------

## 8.2 RK3566 状态机

```
[READY]
   ↓ 用户触发/AI 决策
[MOVING]
   ↓ 收到安全事件 0x82
[PAUSED]
   ↓ 用户继续
[MOVING]
   ↓ 用户停止
[STOPPED]
```

------

# 9. CRC8/MAXIM 算法说明

公式：

- Polynomial = 0x31
- Init = 0x00
- RefIn = True
- RefOut = True
- XorOut = 0x00

CRC 计算数据：**CMD + LEN + PAYLOAD**

------

# 10. 示例代码（C风格伪代码）

```
uint8_t calc_crc(uint8_t *data, uint8_t len) {
    uint8_t crc = 0x00;
    for (int i=0; i<len; i++) {
        crc ^= data[i];
        for (int j=0; j<8; j++) {
            if (crc & 0x01) crc = (crc >> 1) ^ 0x8C;
            else crc >>= 1;
        }
    }
    return crc;
}
```

------

# 11. 建议的 FreeRTOS 任务划分（STM32）

| 任务          | 周期     | 职责                  |
| ------------- | -------- | --------------------- |
| `comm_task`   | 实时     | UART 解包，执行 CMD   |
| `motion_task` | 10ms     | PID、电机控制         |
| `sensor_task` | 10–20ms  | 电压、电流、温度、ToF |
| `status_task` | 30–100ms | 发送状态包            |
| `safety_task` | 实时     | 过流/撞击/急停检测    |

------

# 12. 建议的 RK3566 侧服务模块

- `motion_service`（速度输出接口）
- `chassis_controller`（差速规划、滤波）
- `gimbal_controller`（云台）
- `uart_driver`（协议编解码）
- `safety_handler`（处理事件 0x82）
- `heartbeat_manager`（定时发送 CMD=0x01）